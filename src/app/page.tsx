'use client';

import React, { useEffect, useState } from 'react';
import Image from 'next/image';
import { usePathname } from 'next/navigation';
import { useTelegramUser, useTelegram } from '@/hooks/useTelegram';
import { ArrowLeftIcon } from '@heroicons/react/24/outline';
import { getActiveChart } from '../../lib/birth/storage';
import type { SavedChart } from '../../lib/birth/storage';
import NatalWheel, { type ChartData } from '@/components/natal/NatalWheel';

export default function HomePage() {
  const { firstName, photoUrl, userId } = useTelegramUser();
  const { hapticFeedback } = useTelegram();
  const pathname = usePathname();
  const showBack = pathname !== '/';
  const [activeChart, setActiveChart] = useState<SavedChart | null>(null);
  const [chart, setChart] = useState<ChartData | 'loading' | 'error' | null>(null);
  const [loading, setLoading] = useState(false);
  const [profile, setProfile] = useState<any>(null);

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏
  useEffect(() => {
    if (userId) {
      loadProfile();
    }
  }, [userId]);

  const loadProfile = async () => {
    try {
      const res = await fetch(`/api/profile?tgId=${userId}`);
      if (res.ok) {
        const data = await res.json();
        setProfile(data.profile);
      }
    } catch (error) {
      console.error('Error loading profile:', error);
    }
  };

  const birth = activeChart?.input;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const tg = (typeof window !== 'undefined') ? (window as any).Telegram?.WebApp?.initDataUnsafe?.user : null;
  const displayName = profile?.preferredName || 
    [tg?.first_name, tg?.last_name].filter(Boolean).join(' ') || 
    firstName || 
    '–ì–æ—Å—Ç—å';

  useEffect(() => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É
    const savedChart = getActiveChart();
    setActiveChart(savedChart);
  }, []);

  useEffect(() => {
    if (!birth) { 
      setChart(null); 
      return; 
    }
    
    let stop = false;
    
    (async () => {
      try {
        setChart('loading');
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–æ–∂–¥–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç API
        const date = new Date(birth.date);
        const [hours, minutes] = birth.time.split(':').map(Number);
        
        const birthData = {
          year: date.getFullYear(),
          month: date.getMonth() + 1,
          day: date.getDate(),
          hour: hours || 12,
          minute: minutes || 0,
          lat: birth.place?.lat || 0,
          lon: birth.place?.lon || 0,
          tz: birth.place?.tz || 'UTC',
          place: birth.place?.displayName
        };

        const r = await fetch('/api/natal/compute', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ birth: birthData })
        });

        if (!r.ok) throw 0;
        
        const response = await r.json();
        
        if (!stop && response.success && response.data) {
          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ API –≤ —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ NatalWheel
          const apiData = response.data;
          
          const planets = apiData.planets.map((planet: { name: string; lon: number; speed?: number }) => ({
            id: planet.name,
            lon: planet.lon,
            speed: planet.speed
          }));

          const houses = apiData.houses.cusps.map((cusp: { degree: number }, index: number) => ({
            index: index + 1,
            lon: cusp.degree
          }));

          // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∞—Å–ø–µ–∫—Ç—ã
          const aspects = apiData.aspects.map((aspect: { planet1: string; planet2: string; type: string; orb: number }) => ({
            a: aspect.planet1,
            b: aspect.planet2,
            type: aspect.type,
            orb: aspect.orb
          }));

          const d = {
            planets,
            houses,
            aspects
          };
          
          if (!stop) setChart(d);
        }
      } catch { 
        if (!stop) setChart('error'); 
      }
    })();
    
    return () => { stop = true; };
  }, [birth]);

  const handleNatalChartClick = () => {
    hapticFeedback('impact', 'medium');
    window.location.href = '/natal';
  };

  const openInsight = (e: any) => {
    console.log('select', e);
    hapticFeedback('impact', 'light');
  };

  return (
    <main className="safe-page px-4 pb-20">
      <div className="page animate-fadeIn min-h-screen flex flex-col">
        {/* –®–∞–ø–∫–∞ –∫–∞–∫ –Ω–∞ –º–∞–∫–µ—Ç–µ */}
        <header className="flex items-center justify-between mb-8">
          {showBack && (
            <button className="w-10 h-10 rounded-full bg-white/80 backdrop-blur flex items-center justify-center shadow-sm">
              <ArrowLeftIcon className="w-5 h-5 text-gray-600" />
            </button>
          )}
        <div className="flex items-center gap-2">
          <div className="w-2 h-2 rounded-full bg-gray-300"></div>
          <div className="w-2 h-2 rounded-full bg-gray-300"></div>
          <div className="w-2 h-2 rounded-full bg-accent-1"></div>
        </div>
      </header>

      {/* –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */}
      <div className="flex-1 flex flex-col items-center justify-center text-center">
        {/* –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
        <div className="mb-8">
          {photoUrl ? (
            <Image
              src={photoUrl}
              alt={firstName || 'User'}
              width={120}
              height={120}
              unoptimized
              className="w-[120px] h-[120px] rounded-full border-4 border-white shadow-lg mx-auto"
            />
          ) : (
            <div className="w-[120px] h-[120px] bg-gradient-to-br from-purple-100 to-pink-100 rounded-full flex items-center justify-center border-4 border-white shadow-lg mx-auto">
              <div className="text-4xl">ü•∞</div>
            </div>
          )}
        </div>

        {/* –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ */}
        <div className="mb-12">
          <h1 className="text-4xl font-bold text-gray-800 mb-4 leading-tight">
            –ü—Ä–∏–≤–µ—Ç,<br />{displayName}!
          </h1>
          {activeChart?.input?.date ? (
            <p className="text-gray-600 text-lg">
              {new Date(activeChart.input.date).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long', 
                day: 'numeric'
              })}
            </p>
          ) : (
            <button
              onClick={() => window.location.href = '/natal'}
              className="text-purple-600 text-lg underline hover:text-purple-700 transition-colors"
            >
              –£–∫–∞–∑–∞—Ç—å –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è
            </button>
          )}
          {userId && (
            <p className="text-gray-400 text-sm mt-2">
              ID: {userId}
            </p>
          )}
        </div>

        {/* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–µ—Å–æ */}
        <div className="mt-6 flex justify-center">
          {chart && chart !== 'error' && chart !== 'loading' && typeof chart === 'object' ? (
            <NatalWheel data={chart} size={320} onSelect={(e) => openInsight(e)} />
          ) : (
            <img
              src="/art/astrot-wheel-classic.svg" 
              alt="Astrot wheel"
              width={320} 
              height={320}
              className="rounded-full select-none" 
              draggable={false}
            />
          )}
        </div>

        {/* –ö–Ω–æ–ø–∫–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ */}
        <div className="mt-6">
          <a href="/horoscope" className="btn-primary w-full block text-center">
            –ì–æ—Ä–æ—Å–∫–æ–ø –¥–Ω—è
          </a>
        </div>

        {/* –ö–Ω–æ–ø–∫–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç—ã */}
        <div className="mt-4">
          <button
            onClick={handleNatalChartClick}
            className="btn-secondary w-full max-w-sm py-4 text-lg"
          >
            {activeChart ? '–ú–æ—è –Ω–∞—Ç–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞' : '–°–æ–∑–¥–∞—Ç—å –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É'}
          </button>
        </div>
      </div>
      </div>
    </main>
  );
}