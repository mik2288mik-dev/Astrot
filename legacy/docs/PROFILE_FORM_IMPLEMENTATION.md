# Реализация ProfileForm с геокодингом и CRUD API

## Обзор реализации

Полностью реализована система профилей пользователей с формой, геокодингом, API и E2E тестами.

## 1. Компонент ProfileForm ✅

**Файл:** `src/components/profile/ProfileForm.tsx`

### Реализованные поля:
- **name** - текстовое поле для имени (обязательное, макс 100 символов)
- **birthDate** - поле даты рождения (обязательное, формат YYYY-MM-DD)
- **birthTime** - поле времени рождения (формат HH:MM)
- **unknownTime** - чекбокс "Не знаю время" (отключает поле времени)
- **location** - поле места с автодополнением (обязательное)
- **houseSystem** - переключатель P/W (Placidus/Whole Sign)

### Особенности:
- ✅ Валидация без дефолтов через Zod схемы
- ✅ Кнопка submit отключена до заполнения всех обязательных полей
- ✅ Кнопка "Новый расчёт" полностью сбрасывает форму
- ✅ Responsive дизайн для мобильных устройств
- ✅ Автодополнение мест с интеграцией геокодинг API

## 2. API геокодинга ✅

**Файл:** `src/app/api/geocode/route.ts`
**Утилита:** `src/lib/geo/geocode.ts`
**Timezone:** `src/lib/geo/timezone.ts`

### Функциональность:
- ✅ Proxy для Nominatim OpenStreetMap API
- ✅ Возвращает: name, lat, lon, timezone, tzOffset
- ✅ Интеграция с tz-lookup для определения часовых поясов
- ✅ Автозаполнение координат и часового пояса в форме

### Пример ответа:
```json
{
  "places": [{
    "displayName": "Москва, Россия",
    "lat": 55.7558,
    "lon": 37.6176,
    "country": "Россия", 
    "cityLikeLabel": "Москва, Россия",
    "timezone": "Europe/Moscow",
    "tzOffset": 3
  }]
}
```

## 3. CRUD API профилей ✅

**Файл:** `src/app/api/profile/route.ts`
**Типы:** `types/profile.ts`
**Авторизация:** `src/lib/auth/telegram.ts`

### Endpoints:
- **GET** `/api/profile?tgId={id}` - получение профиля
- **POST** `/api/profile` - создание нового профиля
- **PUT** `/api/profile` - обновление профиля
- **DELETE** `/api/profile?tgId={id}` - удаление профиля

### Особенности:
- ✅ Хранение в Vercel KV по ключу `profile:{tgId}`
- ✅ Zod схемы для валидации данных
- ✅ Автоматические createdAt/updatedAt
- ✅ Авторизация по Telegram `initDataUnsafe.user`
- ✅ Возврат полного объекта Profile

## 4. E2E тестирование ✅

**Файл:** `e2e/profile-form.spec.ts`

### Покрытые сценарии:
- ✅ Отображение пустой формы с корректными полями
- ✅ Валидация полей при отправке пустой формы
- ✅ Работа чекбокса "Не знаю время"
- ✅ Автодополнение и выбор мест
- ✅ Переключение системы домов
- ✅ Сброс формы кнопкой "Новый расчёт"
- ✅ Активация кнопки submit при заполнении обязательных полей
- ✅ Успешное создание нового профиля (POST /api/profile)
- ✅ Загрузка и обновление существующего профиля (GET /api/profile)
- ✅ Responsive дизайн на мобильных устройствах

## 5. Интеграция с существующим кодом ✅

### Обновлённые файлы:
- `src/app/profile/page.tsx` - добавлена ссылка на форму профиля
- `src/app/profile/form/page.tsx` - новая страница с формой профиля
- `src/lib/geo/geocode.ts` - расширен для поддержки timezone
- Централизованные типы в `types/profile.ts`

## Структура файлов

```
src/
├── app/
│   ├── api/
│   │   ├── geocode/route.ts          # Геокодинг API
│   │   └── profile/route.ts          # CRUD API профилей
│   └── profile/
│       ├── page.tsx                  # Главная страница профиля
│       └── form/page.tsx             # Страница формы профиля
├── components/
│   └── profile/
│       └── ProfileForm.tsx           # Основной компонент формы
├── lib/
│   ├── auth/
│   │   └── telegram.ts               # Telegram авторизация
│   └── geo/
│       ├── geocode.ts                # Геокодинг утилиты
│       └── timezone.ts               # Timezone утилиты
└── types/
    └── profile.ts                    # Централизованные типы

e2e/
└── profile-form.spec.ts              # E2E тесты
```

## Использование

1. Перейти на `/profile/form` для создания/редактирования профиля
2. Заполнить все обязательные поля
3. Использовать автодополнение для выбора места рождения
4. Система автоматически определит часовой пояс
5. Сохранить профиль или сбросить форму

## Тестирование

Запуск E2E тестов:
```bash
pnpm run test:e2e profile-form
```

Проверка типов:
```bash
pnpm run typecheck
```

Сборка проекта:
```bash
pnpm run build
```